### 1. 流程

### 设置向导(wizard)页面？

* 出厂设置

  页面：【通道参数】

  ![image-20250811100650189](D:\notes\笔记Img\image-20250811100650189.png)

  ![image-20250811100630265](D:\notes\笔记Img\image-20250811100630265.png)

  页面：【微震采集参数】

  ![image-20250811095228050](D:\notes\笔记Img\image-20250811095228050.png)

​	页面：【电法采集参数】![image-20250811095356414](D:\notes\笔记Img\image-20250811095356414.png)

页面：【温度采集参数】

![image-20250811095503261](D:\notes\笔记Img\image-20250811095503261.png)

* 配置项目基本信息`e_info`

  页面：【工程参数】![image-20250811094634568](D:\notes\笔记Img\image-20250811094634568.png)

* 配置空间参数

  页面：【空间参数】

  ![image-20250811094807935](D:\notes\笔记Img\image-20250811094807935.png)

* 配置掘进基本信息`mining_basic_info`，掘进班次基本信息`mining_shift_info`

  > * 页面：
  >
  >   

* 配置观测系统基本信息`observation_system_info`

  > * 页面：
  >
  >   

* 通道信息`e_chns_config`，基准通道号

  > * 页面：通道配置
  >
  >   ![image-20250811101828006](D:\notes\笔记Img\image-20250811101828006.png)
  >
  >   ![image-20250811101851168](D:\notes\笔记Img\image-20250811101851168.png)

* 配置监测基本信息`observation_info`

  > * 页面：
  >
  >   实时参数-用户参数？

* 配置预测基本信息`forecast_info`

  > * 页面：
  >
  >   实时参数-异常预测

### 2. 初始化

* 由`mining_basic_info`初始化`e_tunnel_locInfo`

  ```cpp
  mining_loc<---mining_locx_start;//起始里程
  tmstamp<---updatetime;//配置时间。存疑。
  updatetime<---current_timestamp();//当前时间
  day_step<---;
  day_step_avg<---;
  firstChnNO_S<---;
  firstChnNO_R;
  firstChnNO_E;
  heading_mil_S<---mining_locx_start，firstChnNO_S
  heading_mil_R;
  heading_mil_E;
  description<---"系统初始化"
  ```

### 3. 表关联

* locInfo-`tmstamp`里程时间

  e_chn_config_history-`updatetime`坐标修改时间

* e_tunnel_mining_basic_info-`mining_shifts_num`掘进班数

  e_tunnel_mining_shift_info-`shift_id`班次号

  ​	班次号<=班数，INSERT/UPDATE时应用层代码限制，or触发器限制

  ```mysql
  -- 触发器限制
  DELIMITER $$
  
  CREATE TRIGGER check_shift_id_before_insert
  BEFORE INSERT ON e_tunnel_mining_shift_info
  FOR EACH ROW
  BEGIN
    DECLARE max_id INT;
    SELECT mining_shifts_num INTO max_id FROM e_tunnel_mining_basic_info;
    IF NEW.id > max_id THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'shift_id exceeds mining_shifts_num';
    END IF;
  END$$
  
  CREATE TRIGGER check_shift_id_before_update
  BEFORE UPDATE ON e_tunnel_mining_shift_info
  FOR EACH ROW
  BEGIN
    DECLARE max_id INT;
    SELECT mining_shifts_num INTO max_id FROM e_tunnel_mining_basic_info;
    IF NEW.id > max_id THEN
      SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'shift_id exceeds mining_shifts_num';
    END IF;
  END$$
  
  DELIMITER ;
  ```

  ​	

### 4. 旧代码影响

* e_tunnel_mining_basic_info-`mining_dir`

  `e_mining_PCOLocParm`-`mining_dir`

* 监测基本信息表，写入e_tunnel_observation_info-`observation_depth`监测距离

  页面：实时参数-用户参数。写入e_mining_PCOLocParm-`mark_XLen`，监测前方距离(m)

  监测频度(min)

* e_tunnel_forecast_info-预测距离上下限

  页面：实时参数-异常预测。写入e_tunnel_threshold-`markLenX`，预测距离

* 用户参数-回采位置

  现在是写死1000，写入表`e_mining_PCOLocParm`

  

### 5. 建表

#### （1）掘进基本信息——表`e_tunnel_mining_basic_info`

* 【配置时间】：`updatetime`，类型`datetime`

* 【总里程】：`mining_locx_total `，类型`float`

* 【起始里程】：`mining_locx_start`，类型`float`

  > * `locInfo`初始化记录。

* 【掘进方向】：`mining_dir`，类型`tinyint(1)`

* 【掘进班数】：`mining_shifts_num`，类型`tinyint(3)`

* 【单班时长】：`shift_duration`，类型`tinyint(3)`

```mysql
CREATE TABLE e_tunnel_mining_basic_info (
    updatetime DATETIME NOT NULL COMMENT '配置时间',
    mining_locx_total FLOAT NOT NULL COMMENT '总里程(m)',
    mining_locx_start FLOAT NOT NULL COMMENT '起始里程(m)',
    mining_dir TINYINT(1) NOT NULL COMMENT '掘进方向(0-正，1-反)',
    mining_shifts_num TINYINT(3) NOT NULL COMMENT '掘进班数',
    shift_duration TINYINT(3) NOT NULL COMMENT '单班时长(h)',
    PRIMARY KEY (updatetime)
) ENGINE = InnoDB CHARACTER SET = latin1 COLLATE = latin1_swedish_ci ROW_FORMAT = Dynamic COMMENT='掘进基本信息表';
```

#### （2）掘进班次基本信息——表`e_tunnel_mining_shift_info`

* 【班次号】：`shift_id`，类型：`tinyint(3)`，"1"
* 【起始时间】：`shift_start_time`，类型`datetime`
* 【截止时间】：`shift_end_time`，类型`datetime`
* 【班次名称】：`shift_name`，类型`varchar`
* 【设置时间】：`updatetime`，类型`datetime`

```mysql
CREATE TABLE e_tunnel_mining_shift_info (
    shift_id VARCHAR(10) NOT NULL COMMENT '班次号',
    shift_start_time DATETIME NOT NULL COMMENT '起始时间',
    shift_end_time DATETIME NOT NULL COMMENT '截止时间',
    shift_name VARCHAR(50) NOT NULL COMMENT '班次名称',
    updatetime DATETIME NOT NULL COMMENT '设置时间',
    PRIMARY KEY (shift_id)
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Dynamic COMMENT='掘进班次基本信息表';
```

#### （3）观测系统基本信息——表`e_tunnel_observation_system_info`

* 【布置方式】：`system_type_id`，类型：`int`（0-巷道式，1-机载式，...）

* 【观测模式】：`observation_mode_id`，类型`int`（0-单巷，1-双巷，2-多巷）】

* 【通道顺序】：`chn_order_type_id`，类型`tinyint(3)`（0-常规，1-非常规）

* 【最小偏移距】：`heading_mil_lower_limit`，类型`float`

  > * 页面偏移距提醒。

* 【最大偏移距】：`heading_mil_upper_limit`，类型`float`

```mysql
CREATE TABLE e_tunnel_observation_system_info (
    system_type_id INT NOT NULL COMMENT '布置方式（0—巷道式，1-机载式，...）',
    observation_mode_id INT NOT NULL COMMENT '观测模式（0-单巷，1-双巷，2-多巷）',
    chn_order_type_id TINYINT(3) NOT NULL COMMENT '通道顺序（0-常规，1-非常规）',
    heading_mil_lower_limit FLOAT NOT NULL COMMENT '最小偏移距(m)',
    heading_mil_upper_limit FLOAT NOT NULL COMMENT '最大偏移距(m)',
    PRIMARY KEY (system_type_id, observation_mode_id, chn_order_type_id)
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Dynamic COMMENT='观测系统基本信息表';
```

#### （4）里程信息——表`e_tunnel_locInfo`

* 新建字段：【操作时间】：`updatetime`，类型`datetime(4)`。原来的`tmstamp`作为【里程时间】。

  > * 操作时间，用户操作日志。
>
  > * **里程时间，关联通道历史修改时间。**

* 新建字段：【平均日进尺】`avg_day_step`，类型`float`。原来的`day_step`作为【进尺】，类型`float`。

* 新建字段：【现场描述】`description`，类型`varchar`。

  > * 可为空，用户输入文本描述(or图片)。

  ```mysql
  ALTER TABLE e_tunnel_locInfo ADD COLUMN IF NOT EXISTS `updatetime` DATETIME(4) NOT NULL DEFAULT CURRENT_TIMESTAMP() COMMENT '操作时间:编辑‘里程值’时的时间' AFTER `tmstamp`;
  
  ALTER TABLE e_tunnel_locInfo MODIFY COLUMN `tmstamp` DATETIME(4) NOT NULL COMMENT '里程时间:掘进至‘里程值’时的时间';
  
  ALTER TABLE e_tunnel_locInfo MODIFY COLUMN `day_step` float NOT NULL COMMENT '进尺(m)';
  
  ALTER TABLE e_tunnel_locInfo ADD COLUMN IF NOT EXISTS `day_step_avg` float NOT NULL COMMENT '平均日进尺(m)' AFTER `day_step`;
  
  ALTER TABLE e_tunnel_locInfo ADD COLUMN IF NOT EXISTS `description` varchar(100) DEFAULT NULL COMMENT '现场描述';
  ```

#### （5）监测基本信息——表`e_tunnel_observation_info`

* 【应用类型】：`application_id`，类型`tinyint`（3）（0-偏移成像，1-频谱成像...2-速度曲线）

* 【应用标记】：`apply_location_id`，类型`tinyint(3)`（0-前方ahead，1-左帮left_wall，2-右帮right_wall，3-顶板roof，4-底板floor）

  > * 表明探测方向。

* 【监测深度】：`observation_depth`，类型`float`。超前探测距离(m)

* 【监测宽度】：`observation_width`，类型`float`。侧帮距离(m)

* 【监测高度】：`observation_height`，类型`float`。顶底板距离(m)

```mysql
CREATE TABLE e_tunnel_observation_info (
    application_id TINYINT(3) NOT NULL COMMENT '应用类型（0-偏移成像，1-频谱成像，2-速度曲线）',
    apply_location_id TINYINT(3) NOT NULL COMMENT '应用标记（0-前方ahead，1-左帮left_wall，2-右帮right_wall，3-顶板roof，4-底板floor）',
    observation_depth FLOAT NOT NULL COMMENT '监测深度（超前探测距离，单位：m）',
    observation_width FLOAT NOT NULL COMMENT '监测宽度（侧帮距离，单位：m）',
    observation_height FLOAT NOT NULL COMMENT '监测高度（顶底板距离，单位：m）',
    PRIMARY KEY (application_id, apply_location_id)
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Dynamic COMMENT='监测基本信息表';
```

#### （6）预测基本信息——表`e_tunnel_forecast_info`

* 【更新时间】：`updatetime`，类型`datetime`
* 【超前预测最小距离】：`advance_forecast_distance_lower_limit`，类型`float`
* 【超前预测最大距离】：`advance_forecast_distance_upper_limit`，类型`float`
* 【预测频度标记】：`forecast_freq_type_id`，类型`tinyint(3)`（0-时间，1-距离，2-时间+距离）
* 【时间频度】：`time_freq`，类型`float`。单位min
* 【距离频度】：`distance_freq`，类型`float`。单位m

```mysql
CREATE TABLE e_tunnel_forecast_info (
    updatetime DATETIME NOT NULL COMMENT '更新时间',
    advance_forecast_distance_lower_limit FLOAT NOT NULL COMMENT '超前预测最小距离（m）',
    advance_forecast_distance_upper_limit FLOAT NOT NULL COMMENT '超前预测最大距离（m）',
    forecast_freq_type_id TINYINT(3) NOT NULL COMMENT '预测频度标记（0-时间，1-距离，2-时间+距离）',
    time_freq FLOAT NOT NULL COMMENT '时间频度（min）',
    distance_freq FLOAT NOT NULL COMMENT '距离频度（m）',
    PRIMARY KEY (updatetime)
) ENGINE = InnoDB CHARACTER SET = utf8mb4 COLLATE = utf8mb4_unicode_ci ROW_FORMAT = Dynamic COMMENT='预测基本信息表';
```

